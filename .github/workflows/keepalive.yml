name: Keep Strapi Awake

on:
  schedule:
    # Every 10 minutes - ensures we ping well before 15-minute downscale
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: read
concurrency:
  group: strapi-keepalive
  cancel-in-progress: false  # Don't cancel - let each ping complete

jobs:
  ping:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 4  # Balanced timeout

    steps:
      - name: Ping Strapi (warm + verify, with retry)
        env:
          STRAPI_URL: ${{ secrets.STRAPI_URL }}
        run: |
          set -euo pipefail
          echo "Pinging Strapi at ${STRAPI_URL}"
          attempt=0
          success=0
          max_attempts=4

          # up to 4 tries - fits comfortably within 4-minute timeout
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt+1))
            echo "Attempt $attempt/$max_attempts..."

            # Warm-up request with generous timeout for cold starts
            code1=$(curl -m 45 -sS -o /dev/null -w "%{http_code}" "$STRAPI_URL" || echo 599)
            echo "Warm-up HTTP code: $code1"

            # If warm-up succeeded, verify with a quick second call
            if [ "${code1:-999}" -lt 500 ]; then
              sleep 2
              code2=$(curl -m 20 -sS -o /dev/null -w "%{http_code}" "$STRAPI_URL" || echo 599)
              echo "Verify HTTP code: $code2"

              if [ "${code2:-999}" -lt 500 ]; then
                success=1
                echo "✓ Strapi is awake and responding"
                break
              fi
            fi

            # Only backoff if not the last attempt
            if [ $attempt -lt $max_attempts ]; then
              backoff=$((8 + (attempt * 4)))
              echo "Waiting ${backoff}s before retry..."
              sleep $backoff
            fi
          done

          if [ $success -eq 1 ]; then
            echo "✓ Strapi keepalive successful"
            exit 0
          else
            echo "✗ Strapi did not respond after $attempt attempts"
            exit 1
          fi
