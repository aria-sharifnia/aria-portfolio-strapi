name: Keep Strapi Awake

on:
  schedule:
    - cron: "6,18,30,42,54 * * * *"
    - cron: "12,24,36,48 * * * *"
  workflow_dispatch:

permissions:
  contents: read
concurrency:
  group: strapi-keepalive
  cancel-in-progress: true

jobs:
  ping:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Ping Strapi (warm + verify, with small retry)
        env:
          STRAPI_URL: ${{ secrets.STRAPI_URL }}
        run: |
          set -euo pipefail
          echo "Pinging Strapi at ${STRAPI_URL}"
          attempt=0
          success=0

          # up to 3 tries within the 3-min job timeout
          while [ $attempt -lt 3 ]; do
            attempt=$((attempt+1))
            echo "Attempt $attempt..."

            # Warm-up request
            code1=$(curl -m 20 -sS -o /dev/null -w "%{http_code}" "$STRAPI_URL" || echo 599)
            # brief pause, then verify
            sleep 8
            code2=$(curl -m 20 -sS -o /dev/null -w "%{http_code}" "$STRAPI_URL" || echo 599)
            echo "HTTP codes: $code1, $code2"

            # succeed if either call is < 500 (200/301/404 are fine for wake-up)
            if [ "${code1:-999}" -lt 500 ] || [ "${code2:-999}" -lt 500 ]; then
              success=1
              break
            fi

            # short backoff before retrying
            sleep 12
          done

          if [ $success -eq 1 ]; then
            echo "Strapi responded (<500)."
            exit 0
          else
            echo "Strapi did not respond successfully (>=500)."
            exit 1
          fi
